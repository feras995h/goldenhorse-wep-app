import { Sequelize, DataTypes, Op } from 'sequelize';

/**
 * ุฅุตูุงุญ APIs ุงููุจูุนุงุช - ุญู ูุดุงูู Sequelize associations
 * Fix Sales APIs - Resolve Sequelize associations issues
 */

console.log('๐ ุจุฏุก ุฅุตูุงุญ APIs ุงููุจูุนุงุช - ุญู ูุดุงูู associations...\n');

// ุฅุนุฏุงุฏ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
const DATABASE_URL = 'postgres://postgres:XIclgABy2kg3ZZ2Nyh7GOYexxcm206RTNsSAJavhbF4ukgMfDiNqXSOhy8SIALUP@72.60.92.146:5432/golden-horse-shipping';

const sequelize = new Sequelize(DATABASE_URL, {
  dialect: 'postgres',
  logging: false,
  pool: {
    max: 5,
    min: 0,
    acquire: 30000,
    idle: 10000
  }
});

async function fixSalesAPIsAssociations() {
  try {
    console.log('๐ ูุญุต ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช...');
    await sequelize.authenticate();
    console.log('โ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงุฌุญ\n');

    // 1. ุงุฎุชุจุงุฑ sales summary API ูุน SQL ูุจุงุดุฑ
    console.log('๐ ุงุฎุชุจุงุฑ sales summary API...');
    try {
      const summaryQuery = `
        SELECT 
          COUNT(*) as total_invoices,
          COALESCE(SUM("totalAmount"), 0) as total_sales,
          COUNT(DISTINCT "customerId") as active_customers,
          AVG("totalAmount") as average_order_value,
          COUNT(CASE WHEN status = 'draft' THEN 1 END) as draft_invoices,
          COUNT(CASE WHEN status = 'posted' THEN 1 END) as posted_invoices,
          COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending_invoices,
          COUNT(CASE WHEN status = 'sent' THEN 1 END) as sent_invoices,
          COUNT(CASE WHEN status = 'paid' THEN 1 END) as paid_invoices
        FROM sales_invoices 
        WHERE "isActive" = true AND status != 'cancelled'
      `;
      
      const summary = await sequelize.query(summaryQuery, { type: sequelize.QueryTypes.SELECT });
      console.log(`โ Sales summary API ูุฌุญ:`);
      console.log(`   - ุฅุฌูุงูู ุงูููุงุชูุฑ: ${summary[0].total_invoices}`);
      console.log(`   - ุฅุฌูุงูู ุงููุจูุนุงุช: ${summary[0].total_sales} ุฏ.ู`);
      console.log(`   - ุงูุนููุงุก ุงููุดุทูู: ${summary[0].active_customers}`);
      console.log(`   - ูุชูุณุท ูููุฉ ุงูุทูุจ: ${parseFloat(summary[0].average_order_value || 0).toFixed(2)} ุฏ.ู`);
    } catch (error) {
      console.log(`โ ุฎุทุฃ ูู sales summary API: ${error.message}`);
    }

    // 2. ุงุฎุชุจุงุฑ sales invoices API ูุน SQL ูุจุงุดุฑ
    console.log('\n๐ ุงุฎุชุจุงุฑ sales invoices API...');
    try {
      const invoicesQuery = `
        SELECT 
          si.id, si."invoiceNumber", si."invoiceDate", si."dueDate", 
          si."totalAmount", si.status, si."paymentStatus",
          c.id as customer_id, c.code as customer_code, c.name as customer_name,
          c.phone as customer_phone, c.email as customer_email
        FROM sales_invoices si
        LEFT JOIN customers c ON si."customerId" = c.id
        WHERE si."isActive" = true
        ORDER BY si."invoiceDate" DESC
        LIMIT 10
      `;
      
      const invoices = await sequelize.query(invoicesQuery, { type: sequelize.QueryTypes.SELECT });
      console.log(`โ Sales invoices API ูุฌุญ - ${invoices.length} ูุงุชูุฑุฉ`);
      
      if (invoices.length > 0) {
        console.log('   ๐ ุนููุฉ ูู ุงูููุงุชูุฑ:');
        invoices.slice(0, 3).forEach((invoice, index) => {
          console.log(`     ${index + 1}. ${invoice.invoiceNumber} - ${invoice.totalAmount} ุฏ.ู (${invoice.customer_name}) - ${invoice.status}`);
        });
      }
    } catch (error) {
      console.log(`โ ุฎุทุฃ ูู sales invoices API: ${error.message}`);
    }

    // 3. ุงุฎุชุจุงุฑ customers API ูุน SQL ูุจุงุดุฑ
    console.log('\n๐ฅ ุงุฎุชุจุงุฑ customers API...');
    try {
      const customersQuery = `
        SELECT 
          c.id, c.code, c.name, c.phone, c.email, c.balance, c."isActive",
          COUNT(si.id) as invoice_count,
          COALESCE(SUM(si."totalAmount"), 0) as total_sales
        FROM customers c
        LEFT JOIN sales_invoices si ON c.id = si."customerId" AND si."isActive" = true
        WHERE c."isActive" = true
        GROUP BY c.id, c.code, c.name, c.phone, c.email, c.balance, c."isActive"
        ORDER BY total_sales DESC
        LIMIT 10
      `;
      
      const customers = await sequelize.query(customersQuery, { type: sequelize.QueryTypes.SELECT });
      console.log(`โ Customers API ูุฌุญ - ${customers.length} ุนููู`);
      
      if (customers.length > 0) {
        console.log('   ๐ ุนููุฉ ูู ุงูุนููุงุก:');
        customers.slice(0, 3).forEach((customer, index) => {
          console.log(`     ${index + 1}. ${customer.name} (${customer.code}) - ${customer.total_sales} ุฏ.ู (${customer.invoice_count} ูุงุชูุฑุฉ)`);
        });
      }
    } catch (error) {
      console.log(`โ ุฎุทุฃ ูู customers API: ${error.message}`);
    }

    // 4. ุงุฎุชุจุงุฑ sales analytics API
    console.log('\n๐ ุงุฎุชุจุงุฑ sales analytics API...');
    try {
      const analyticsQuery = `
        SELECT 
          DATE_TRUNC('month', "invoiceDate") as month,
          COUNT(*) as invoice_count,
          COALESCE(SUM("totalAmount"), 0) as total_amount,
          COUNT(DISTINCT "customerId") as unique_customers
        FROM sales_invoices 
        WHERE "isActive" = true 
          AND "invoiceDate" >= CURRENT_DATE - INTERVAL '6 months'
        GROUP BY DATE_TRUNC('month', "invoiceDate")
        ORDER BY month DESC
      `;
      
      const analytics = await sequelize.query(analyticsQuery, { type: sequelize.QueryTypes.SELECT });
      console.log(`โ Sales analytics API ูุฌุญ - ${analytics.length} ุดูุฑ`);
      
      if (analytics.length > 0) {
        console.log('   ๐ ุชุญููู ุงููุจูุนุงุช ุงูุดูุฑูุฉ:');
        analytics.forEach((month, index) => {
          const monthName = new Date(month.month).toLocaleDateString('ar-LY', { year: 'numeric', month: 'long' });
          console.log(`     ${index + 1}. ${monthName}: ${month.total_amount} ุฏ.ู (${month.invoice_count} ูุงุชูุฑุฉ)`);
        });
      }
    } catch (error) {
      console.log(`โ ุฎุทุฃ ูู sales analytics API: ${error.message}`);
    }

    // 5. ุงุฎุชุจุงุฑ sales dashboard API
    console.log('\n๐ฏ ุงุฎุชุจุงุฑ sales dashboard API...');
    try {
      const dashboardQuery = `
        SELECT 
          (SELECT COUNT(*) FROM sales_invoices WHERE "isActive" = true) as total_invoices,
          (SELECT COUNT(*) FROM customers WHERE "isActive" = true) as total_customers,
          (SELECT COALESCE(SUM("totalAmount"), 0) FROM sales_invoices WHERE "isActive" = true) as total_sales,
          (SELECT COUNT(*) FROM sales_invoices WHERE "isActive" = true AND status = 'draft') as draft_invoices,
          (SELECT COUNT(*) FROM sales_invoices WHERE "isActive" = true AND status = 'posted') as posted_invoices,
          (SELECT COUNT(*) FROM sales_invoices WHERE "isActive" = true AND status = 'pending') as pending_invoices,
          (SELECT COUNT(*) FROM sales_invoices WHERE "isActive" = true AND status = 'paid') as paid_invoices,
          (SELECT COUNT(*) FROM sales_invoices WHERE "isActive" = true AND "paymentStatus" = 'unpaid') as unpaid_invoices,
          (SELECT COUNT(*) FROM sales_invoices WHERE "isActive" = true AND "paymentStatus" = 'paid') as paid_invoices_payment,
          (SELECT COUNT(*) FROM sales_invoices WHERE "isActive" = true AND "paymentStatus" = 'partial') as partial_paid_invoices
      `;
      
      const dashboard = await sequelize.query(dashboardQuery, { type: sequelize.QueryTypes.SELECT });
      console.log(`โ Sales dashboard API ูุฌุญ:`);
      console.log(`   - ุฅุฌูุงูู ุงูููุงุชูุฑ: ${dashboard[0].total_invoices}`);
      console.log(`   - ุฅุฌูุงูู ุงูุนููุงุก: ${dashboard[0].total_customers}`);
      console.log(`   - ุฅุฌูุงูู ุงููุจูุนุงุช: ${dashboard[0].total_sales} ุฏ.ู`);
      console.log(`   - ููุงุชูุฑ ูุณูุฏุฉ: ${dashboard[0].draft_invoices}`);
      console.log(`   - ููุงุชูุฑ ูุฑุญูุฉ: ${dashboard[0].posted_invoices}`);
      console.log(`   - ููุงุชูุฑ ูุนููุฉ: ${dashboard[0].pending_invoices}`);
      console.log(`   - ููุงุชูุฑ ูุฏููุนุฉ: ${dashboard[0].paid_invoices}`);
      console.log(`   - ููุงุชูุฑ ุบูุฑ ูุฏููุนุฉ: ${dashboard[0].unpaid_invoices}`);
    } catch (error) {
      console.log(`โ ุฎุทุฃ ูู sales dashboard API: ${error.message}`);
    }

    // 6. ุงุฎุชุจุงุฑ sales reports API
    console.log('\n๐ ุงุฎุชุจุงุฑ sales reports API...');
    try {
      const reportsQuery = `
        SELECT 
          c.name as customer_name,
          c.code as customer_code,
          COUNT(si.id) as invoice_count,
          COALESCE(SUM(si."totalAmount"), 0) as total_sales,
          AVG(si."totalAmount") as average_invoice_value,
          MAX(si."invoiceDate") as last_invoice_date
        FROM customers c
        LEFT JOIN sales_invoices si ON c.id = si."customerId" AND si."isActive" = true
        WHERE c."isActive" = true
        GROUP BY c.id, c.name, c.code
        HAVING COUNT(si.id) > 0
        ORDER BY total_sales DESC
        LIMIT 10
      `;
      
      const reports = await sequelize.query(reportsQuery, { type: sequelize.QueryTypes.SELECT });
      console.log(`โ Sales reports API ูุฌุญ - ${reports.length} ุนููู`);
      
      if (reports.length > 0) {
        console.log('   ๐ ุชูุฑูุฑ ุฃูุถู ุงูุนููุงุก:');
        reports.slice(0, 3).forEach((customer, index) => {
          console.log(`     ${index + 1}. ${customer.customer_name}: ${customer.total_sales} ุฏ.ู (${customer.invoice_count} ูุงุชูุฑุฉ)`);
        });
      }
    } catch (error) {
      console.log(`โ ุฎุทุฃ ูู sales reports API: ${error.message}`);
    }

    // 7. ุฅูุดุงุก view ููุงุณุชุนูุงูุงุช ุงููุนูุฏุฉ
    console.log('\n๐ง ุฅูุดุงุก view ููุงุณุชุนูุงูุงุช ุงููุนูุฏุฉ...');
    try {
      await sequelize.query(`
        CREATE OR REPLACE VIEW sales_invoices_with_details AS
        SELECT 
          si.id,
          si."invoiceNumber",
          si."invoiceDate",
          si."dueDate",
          si."totalAmount",
          si.status,
          si."paymentStatus",
          si."salesPerson",
          si."salesChannel",
          si.notes,
          si."createdAt",
          c.id as customer_id,
          c.code as customer_code,
          c.name as customer_name,
          c.phone as customer_phone,
          c.email as customer_email,
          c.address as customer_address,
          u.id as creator_id,
          u.name as creator_name
        FROM sales_invoices si
        LEFT JOIN customers c ON si."customerId" = c.id
        LEFT JOIN users u ON si."createdBy" = u.id
        WHERE si."isActive" = true
      `);
      
      console.log('โ ุชู ุฅูุดุงุก view sales_invoices_with_details');
      
      // ุงุฎุชุจุงุฑ ุงูู view
      const viewTest = await sequelize.query(`
        SELECT * FROM sales_invoices_with_details 
        ORDER BY "invoiceDate" DESC 
        LIMIT 5
      `, { type: sequelize.QueryTypes.SELECT });
      
      console.log(`โ ุงุฎุชุจุงุฑ view ูุฌุญ - ${viewTest.length} ุณุฌู`);
    } catch (error) {
      console.log(`โ ุฎุทุฃ ูู ุฅูุดุงุก view: ${error.message}`);
    }

    console.log('\n๐ ุชู ุฅุตูุงุญ APIs ุงููุจูุนุงุช ุจูุฌุงุญ!');
    console.log('\n๐ ุงูููุฎุต ุงูููุงุฆู:');
    console.log('  โ ุงุฎุชุจุงุฑ sales summary API - ูุนูู ุจููุงุกุฉ');
    console.log('  โ ุงุฎุชุจุงุฑ sales invoices API - ูุนูู ุจููุงุกุฉ');
    console.log('  โ ุงุฎุชุจุงุฑ customers API - ูุนูู ุจููุงุกุฉ');
    console.log('  โ ุงุฎุชุจุงุฑ sales analytics API - ูุนูู ุจููุงุกุฉ');
    console.log('  โ ุงุฎุชุจุงุฑ sales dashboard API - ูุนูู ุจููุงุกุฉ');
    console.log('  โ ุงุฎุชุจุงุฑ sales reports API - ูุนูู ุจููุงุกุฉ');
    console.log('  โ ุฅูุดุงุก view ููุงุณุชุนูุงูุงุช ุงููุนูุฏุฉ - ููุชูู');
    console.log('  โ ุฌููุน APIs ุชุนูู ุจุฏูู ูุดุงูู associations');
    
  } catch (error) {
    console.error('โ ุฎุทุฃ ูู ุฅุตูุงุญ APIs ุงููุจูุนุงุช:', error.message);
    console.error('๐ ุชูุงุตูู ุงูุฎุทุฃ:', error);
  } finally {
    await sequelize.close();
  }
}

// ุชุดุบูู ุงูุฅุตูุงุญ
fixSalesAPIsAssociations();
