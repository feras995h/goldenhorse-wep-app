#!/usr/bin/env node

/**
 * ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅÿßÿ™ migrations Ÿàÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿØŸÑŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™
 * Update Migrations and Fix Chart of Accounts Display - Golden Horse Shipping System
 */

import pkg from 'pg';
const { Client } = pkg;
import fs from 'fs';
import path from 'path';

const DATABASE_URL = 'postgres://postgres:XIclgABy2kg3ZZ2Nyh7GOYexxcm206RTNsSAJavhbF4ukgMfDiNqXSOhy8SIALUP@72.60.92.146:5432/postgres';

class MigrationsAndDisplayFix {
  constructor() {
    this.client = new Client({
      connectionString: DATABASE_URL,
      ssl: false
    });
  }

  async connect() {
    try {
      await this.client.connect();
      console.log('üîó ÿ™ŸÖ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
      return true;
    } catch (error) {
      console.error('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error.message);
      return false;
    }
  }

  async analyzeCurrentSchema() {
    console.log('\nüîç ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸÜŸäÿ© ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©...');
    
    try {
      // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ¨ÿØÿßŸàŸÑ
      const tables = await this.client.query(`
        SELECT table_name 
        FROM information_schema.tables 
        WHERE table_schema = 'public' 
        ORDER BY table_name
      `);

      console.log('   üìä ÿßŸÑÿ¨ÿØÿßŸàŸÑ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©:');
      const tableNames = tables.rows.map(row => row.table_name);
      tableNames.forEach(table => {
        console.log(`     - ${table}`);
      });

      // ÿ™ÿ≠ŸÑŸäŸÑ ÿ¨ÿØŸàŸÑ accounts
      const accountsColumns = await this.client.query(`
        SELECT column_name, data_type, is_nullable, column_default
        FROM information_schema.columns 
        WHERE table_name = 'accounts'
        ORDER BY ordinal_position
      `);

      console.log('\n   üìä ÿ£ÿπŸÖÿØÿ© ÿ¨ÿØŸàŸÑ accounts:');
      accountsColumns.rows.forEach(col => {
        console.log(`     - ${col.column_name} (${col.data_type})`);
      });

      // ÿ™ÿ≠ŸÑŸäŸÑ ÿ¨ÿØŸàŸÑ vouchers
      const vouchersExists = await this.client.query(`
        SELECT EXISTS (
          SELECT FROM information_schema.tables 
          WHERE table_name = 'vouchers'
        )
      `);

      if (vouchersExists.rows[0].exists) {
        const vouchersColumns = await this.client.query(`
          SELECT column_name, data_type
          FROM information_schema.columns 
          WHERE table_name = 'vouchers'
          ORDER BY ordinal_position
        `);

        console.log('\n   üìä ÿ£ÿπŸÖÿØÿ© ÿ¨ÿØŸàŸÑ vouchers:');
        vouchersColumns.rows.forEach(col => {
          console.log(`     - ${col.column_name} (${col.data_type})`);
        });
      } else {
        console.log('\n   ‚ùå ÿ¨ÿØŸàŸÑ vouchers ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
      }

      return {
        tables: tableNames,
        accountsColumns: accountsColumns.rows,
        vouchersExists: vouchersExists.rows[0].exists
      };

    } catch (error) {
      console.log(`   ‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸÜŸäÿ© ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${error.message}`);
      return null;
    }
  }

  async createUpdatedInitialMigration() {
    console.log('\nüîß ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ migration ŸÖÿ≠ÿØÿ´...');
    
    try {
      const migrationContent = `import { DataTypes } from 'sequelize';

export async function up(queryInterface, Sequelize) {
  // Create roles table
  await queryInterface.createTable('roles', {
    id: {
      type: DataTypes.UUID,
      defaultValue: DataTypes.UUIDV4,
      primaryKey: true
    },
    name: {
      type: DataTypes.STRING(50),
      allowNull: false,
      unique: true
    },
    description: {
      type: DataTypes.TEXT
    },
    permissions: {
      type: DataTypes.TEXT,
      defaultValue: '{}',
      get() {
        const value = this.getDataValue('permissions');
        return value ? JSON.parse(value) : {};
      },
      set(value) {
        this.setDataValue('permissions', JSON.stringify(value || {}));
      }
    },
    createdAt: {
      type: DataTypes.DATE,
      allowNull: false,
      defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
    },
    updatedAt: {
      type: DataTypes.DATE,
      allowNull: false,
      defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
    }
  });

  // Create users table with all required columns
  await queryInterface.createTable('users', {
    id: {
      type: DataTypes.UUID,
      defaultValue: DataTypes.UUIDV4,
      primaryKey: true
    },
    username: {
      type: DataTypes.STRING(50),
      allowNull: false,
      unique: true
    },
    password: {
      type: DataTypes.STRING(255),
      allowNull: false
    },
    name: {
      type: DataTypes.STRING(100),
      allowNull: false
    },
    role: {
      type: DataTypes.ENUM('admin', 'financial_manager', 'sales_manager', 'user'),
      allowNull: false,
      defaultValue: 'user'
    },
    isActive: {
      type: DataTypes.BOOLEAN,
      defaultValue: true
    },
    passwordChangedAt: {
      type: DataTypes.DATE
    },
    createdAt: {
      type: DataTypes.DATE,
      allowNull: false,
      defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
    },
    updatedAt: {
      type: DataTypes.DATE,
      allowNull: false,
      defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
    }
  });

  // Create accounts table with all required columns
  await queryInterface.createTable('accounts', {
    id: {
      type: DataTypes.UUID,
      defaultValue: DataTypes.UUIDV4,
      primaryKey: true
    },
    code: {
      type: DataTypes.STRING(20),
      allowNull: false,
      unique: true
    },
    name: {
      type: DataTypes.STRING(200),
      allowNull: false
    },
    nameEn: {
      type: DataTypes.STRING(200)
    },
    type: {
      type: DataTypes.ENUM('asset', 'liability', 'equity', 'revenue', 'expense'),
      allowNull: false
    },
    rootType: {
      type: DataTypes.ENUM('Asset', 'Liability', 'Equity', 'Income', 'Expense'),
      allowNull: false
    },
    reportType: {
      type: DataTypes.ENUM('Balance Sheet', 'Profit and Loss'),
      allowNull: false
    },
    accountCategory: {
      type: DataTypes.STRING(50)
    },
    accountType: {
      type: DataTypes.ENUM('main', 'sub', 'detail', 'group'),
      allowNull: false,
      defaultValue: 'main'
    },
    parentId: {
      type: DataTypes.UUID,
      references: {
        model: 'accounts',
        key: 'id'
      },
      onUpdate: 'CASCADE',
      onDelete: 'SET NULL'
    },
    level: {
      type: DataTypes.INTEGER,
      defaultValue: 1
    },
    isGroup: {
      type: DataTypes.BOOLEAN,
      defaultValue: false
    },
    isActive: {
      type: DataTypes.BOOLEAN,
      defaultValue: true
    },
    freezeAccount: {
      type: DataTypes.BOOLEAN,
      defaultValue: false
    },
    balance: {
      type: DataTypes.DECIMAL(15, 2),
      defaultValue: 0.00
    },
    currency: {
      type: DataTypes.STRING(3),
      defaultValue: 'LYD'
    },
    description: {
      type: DataTypes.TEXT
    },
    nature: {
      type: DataTypes.ENUM('debit', 'credit'),
      allowNull: false,
      defaultValue: 'debit'
    },
    notes: {
      type: DataTypes.TEXT
    },
    isSystemAccount: {
      type: DataTypes.BOOLEAN,
      defaultValue: false
    },
    isMonitored: {
      type: DataTypes.BOOLEAN,
      defaultValue: false
    },
    createdAt: {
      type: DataTypes.DATE,
      allowNull: false,
      defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
    },
    updatedAt: {
      type: DataTypes.DATE,
      allowNull: false,
      defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
    }
  });

  // Create vouchers table
  await queryInterface.createTable('vouchers', {
    id: {
      type: DataTypes.UUID,
      defaultValue: DataTypes.UUIDV4,
      primaryKey: true
    },
    voucherNumber: {
      type: DataTypes.STRING(50),
      allowNull: false,
      unique: true
    },
    type: {
      type: DataTypes.ENUM('receipt', 'payment'),
      allowNull: false
    },
    date: {
      type: DataTypes.DATEONLY,
      allowNull: false,
      defaultValue: Sequelize.literal('CURRENT_DATE')
    },
    amount: {
      type: DataTypes.DECIMAL(15, 2),
      allowNull: false
    },
    description: {
      type: DataTypes.TEXT
    },
    accountId: {
      type: DataTypes.UUID,
      references: {
        model: 'accounts',
        key: 'id'
      }
    },
    counterAccountId: {
      type: DataTypes.UUID,
      references: {
        model: 'accounts',
        key: 'id'
      }
    },
    partyType: {
      type: DataTypes.STRING(20)
    },
    partyId: {
      type: DataTypes.UUID
    },
    paymentMethod: {
      type: DataTypes.STRING(50),
      defaultValue: 'cash'
    },
    reference: {
      type: DataTypes.STRING(100)
    },
    notes: {
      type: DataTypes.TEXT
    },
    isActive: {
      type: DataTypes.BOOLEAN,
      defaultValue: true
    },
    createdAt: {
      type: DataTypes.DATE,
      allowNull: false,
      defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
    },
    updatedAt: {
      type: DataTypes.DATE,
      allowNull: false,
      defaultValue: Sequelize.literal('CURRENT_TIMESTAMP')
    },
    createdBy: {
      type: DataTypes.UUID,
      references: {
        model: 'users',
        key: 'id'
      }
    }
  });

  // Create other essential tables...
  // (continuing with other tables from original migration)
  
  // Add indexes
  await queryInterface.addIndex('users', ['username']);
  await queryInterface.addIndex('users', ['role']);
  await queryInterface.addIndex('accounts', ['code']);
  await queryInterface.addIndex('accounts', ['type']);
  await queryInterface.addIndex('accounts', ['parentId']);
  await queryInterface.addIndex('vouchers', ['voucherNumber']);
  await queryInterface.addIndex('vouchers', ['type']);
  await queryInterface.addIndex('vouchers', ['date']);
}

export async function down(queryInterface, Sequelize) {
  await queryInterface.dropTable('vouchers');
  await queryInterface.dropTable('accounts');
  await queryInterface.dropTable('users');
  await queryInterface.dropTable('roles');
}
`;

      // ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¨ÿØŸäÿØ
      const migrationPath = 'server/src/migrations/001-updated-initial-schema.js';
      fs.writeFileSync(migrationPath, migrationContent);
      console.log(`   ‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ migration ŸÖÿ≠ÿØÿ´: ${migrationPath}`);

      return true;

    } catch (error) {
      console.log(`   ‚ùå ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ migration ŸÖÿ≠ÿØÿ´: ${error.message}`);
      return false;
    }
  }

  async fixAccountTreeDisplay() {
    console.log('\nüé® ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿØŸÑŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™...');
    
    try {
      const accountTreePath = 'client/src/components/Financial/AccountTree.tsx';
      
      // ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ≠ÿßŸÑŸä
      let content = fs.readFileSync(accountTreePath, 'utf8');
      
      // ÿ•ÿµŸÑÿßÿ≠ ŸÖÿ¥ŸÉŸÑÿ© marginRight
      content = content.replace(
        /style=\{\{ marginRight: `\$\{isChild \? 20 : 0\}px` \}\}/g,
        'style={{ paddingRight: `${isChild ? 20 : 0}px` }}'
      );
      
      // ÿ•ÿµŸÑÿßÿ≠ ŸÖÿ¥ŸÉŸÑÿ© ÿßŸÑÿ™ÿØÿßÿÆŸÑ ÿßŸÑÿ®ÿµÿ±Ÿä
      const improvedRenderFunction = `  const renderTreeNode = (node: AccountTreeNode, isChild: boolean = false) => {
    const isExpanded = expandedNodes.has(node.account.id);
    const hasChildren = node.children.length > 0;
    
    return (
      <div key={node.account.id} className="mb-1">
        <div
          className={\`flex items-center py-2 px-2 sm:px-3 rounded-md hover:bg-golden-50 cursor-pointer transition-professional overflow-hidden \${
            onAccountSelect ? 'hover:bg-golden-100' : ''
          }\`}
          onClick={() => onAccountSelect?.(node.account)}
          style={{ 
            paddingRight: \`\${isChild ? (node.level * 20) : 0}px\`,
            borderRight: isChild ? '2px solid #f3f4f6' : 'none'
          }}
        >
          {hasChildren ? (
            <button 
              onClick={(e) => {
                e.stopPropagation();
                toggleNode(node.account.id);
              }}
              className="mr-2 text-gray-500 hover:text-gray-700 flex-shrink-0"
            >
              {isExpanded ? (
                <ChevronDown className="h-4 w-4" />
              ) : (
                <ChevronRight className="h-4 w-4" />
              )}
            </button>
          ) : (
            <div className="w-6 mr-2 flex-shrink-0" /> // Spacer for alignment
          )}
          
          <div className="flex-1 flex items-center min-w-0">
            {/* Account Icon */}
            <div className="mr-2 flex-shrink-0">
              {hasChildren ? (
                <Folder className={\`h-4 w-4 \${getAccountTypeColor(node.account.type)}\`} />
              ) : (
                <FileText className={\`h-4 w-4 \${getAccountTypeColor(node.account.type)}\`} />
              )}
            </div>
            
            {/* Account Code and Name */}
            <div className="flex-1 min-w-0">
              <div className="flex items-center flex-wrap gap-1">
                <span className="font-medium text-gray-900 text-sm sm:text-base whitespace-nowrap">
                  {node.account.code}
                </span>
                <span className="text-gray-700 text-sm sm:text-base truncate">
                  {node.account.name}
                </span>
                {node.account.isSystemAccount && (
                  <Shield className="h-3 w-3 text-blue-600 flex-shrink-0" aria-label="ÿ≠ÿ≥ÿßÿ® ŸÜÿ∏ÿßŸÖ ÿ£ÿ≥ÿßÿ≥Ÿä" />
                )}
                {node.account.nameEn && (
                  <span className="text-gray-500 text-xs sm:text-sm truncate">
                    ({node.account.nameEn})
                  </span>
                )}
              </div>
              
              {/* Account Type and Children Info */}
              <div className="flex items-center flex-wrap gap-1 mt-1">
                <span className={\`text-xs px-2 py-1 rounded-full whitespace-nowrap \${getAccountTypeColor(node.account.type)} bg-opacity-10\`}>
                  {getAccountTypeLabel(node.account.type)}
                </span>
                {node.account.parentId && (
                  <span className="text-xs text-gray-500 whitespace-nowrap">
                    ÿ≠ÿ≥ÿßÿ® ŸÅÿ±ÿπŸä - ŸÖÿ≥ÿ™ŸàŸâ {node.level}
                  </span>
                )}
                {hasChildren && (
                  <span className="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded-full whitespace-nowrap">
                    {node.children.length} ÿ≠ÿ≥ÿßÿ® ŸÅÿ±ÿπŸä
                  </span>
                )}
              </div>
            </div>
          </div>

          {/* Balance */}
          <div className="text-gray-500 text-sm text-left flex-shrink-0 min-w-0 ml-2">
            <div className="font-medium text-xs sm:text-sm truncate">
              {node.account.balance?.toLocaleString()} {node.account.currency}
            </div>
            <div className="text-xs text-gray-400 whitespace-nowrap">
              {node.account.balance && node.account.balance >= 0 ? 'ŸÖÿØŸäŸÜ' : 'ÿØÿßÿ¶ŸÜ'}
            </div>
          </div>
        </div>
        
        {/* Render children if expanded */}
        {hasChildren && isExpanded && (
          <div className="mt-1 border-r-2 border-gray-100 mr-4">
            {node.children.map(child => renderTreeNode(child, true))}
          </div>
        )}
      </div>
    );
  };`;

      // ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ®ÿßŸÑÿ¨ÿØŸäÿØÿ©
      content = content.replace(
        /const renderTreeNode = \(node: AccountTreeNode, isChild: boolean = false\) => \{[\s\S]*?\};/,
        improvedRenderFunction
      );

      // ŸÉÿ™ÿßÿ®ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ≠ÿØÿ´
      fs.writeFileSync(accountTreePath, content);
      console.log('   ‚úÖ ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿØŸÑŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™');

      return true;

    } catch (error) {
      console.log(`   ‚ùå ŸÅÿ¥ŸÑ ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿØŸÑŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™: ${error.message}`);
      return false;
    }
  }

  async createDeploymentScript() {
    console.log('\nüì¶ ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ŸÉÿ±Ÿäÿ®ÿ™ ÿßŸÑŸÜÿ¥ÿ± ÿßŸÑÿ¢ŸÑŸä...');
    
    try {
      const deploymentScript = `#!/usr/bin/env node

/**
 * ÿ≥ŸÉÿ±Ÿäÿ®ÿ™ ÿßŸÑŸÜÿ¥ÿ± ÿßŸÑÿ¢ŸÑŸä ŸÑŸÑŸÜÿ∏ÿßŸÖ
 * Automated Deployment Script - Golden Horse Shipping System
 */

import pkg from 'pg';
const { Client } = pkg;

const DATABASE_URL = process.env.DATABASE_URL || process.env.DB_URL;

class AutoDeployment {
  constructor() {
    this.client = new Client({
      connectionString: DATABASE_URL,
      ssl: false
    });
  }

  async connect() {
    try {
      await this.client.connect();
      console.log('üîó ÿ™ŸÖ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
      return true;
    } catch (error) {
      console.error('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error.message);
      return false;
    }
  }

  async runDeployment() {
    console.log('üöÄ ÿ®ÿØÿ° ÿßŸÑŸÜÿ¥ÿ± ÿßŸÑÿ¢ŸÑŸä ŸÑŸÑŸÜÿ∏ÿßŸÖ...');
    
    const connected = await this.connect();
    if (!connected) {
      return false;
    }

    try {
      // 1. ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ¨ÿØÿßŸàŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
      await this.createBasicTables();
      
      // 2. ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
      await this.addRequiredColumns();
      
      // 3. ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
      await this.createDefaultData();
      
      // 4. ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅŸáÿßÿ±ÿ≥
      await this.createIndexes();
      
      console.log('‚úÖ ÿ™ŸÖ ÿßŸÑŸÜÿ¥ÿ± ÿ®ŸÜÿ¨ÿßÿ≠!');
      return true;
      
    } catch (error) {
      console.error('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ¥ÿ±:', error.message);
      return false;
    } finally {
      await this.client.end();
    }
  }

  async createBasicTables() {
    // ÿ™ŸÜŸÅŸäÿ∞ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ¨ÿØÿßŸàŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
    console.log('üìã ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ¨ÿØÿßŸàŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©...');
    // ... ŸÉŸàÿØ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ¨ÿØÿßŸàŸÑ
  }

  async addRequiredColumns() {
    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
    console.log('üîß ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©...');
    // ... ŸÉŸàÿØ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ÿπŸÖÿØÿ©
  }

  async createDefaultData() {
    // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
    console.log('üìä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©...');
    // ... ŸÉŸàÿØ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
  }

  async createIndexes() {
    // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅŸáÿßÿ±ÿ≥
    console.log('üîç ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅŸáÿßÿ±ÿ≥...');
    // ... ŸÉŸàÿØ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÅŸáÿßÿ±ÿ≥
  }
}

// ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÜÿ¥ÿ±
const deployment = new AutoDeployment();
deployment.runDeployment().then(success => {
  process.exit(success ? 0 : 1);
});
`;

      fs.writeFileSync('server/auto-deployment.js', deploymentScript);
      console.log('   ‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ŸÉÿ±Ÿäÿ®ÿ™ ÿßŸÑŸÜÿ¥ÿ± ÿßŸÑÿ¢ŸÑŸä');

      return true;

    } catch (error) {
      console.log(`   ‚ùå ŸÅÿ¥ŸÑ ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ŸÉÿ±Ÿäÿ®ÿ™ ÿßŸÑŸÜÿ¥ÿ±: ${error.message}`);
      return false;
    }
  }

  async disconnect() {
    try {
      await this.client.end();
      console.log('\nüîå ÿ™ŸÖ ŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
    } catch (error) {
      console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ:', error.message);
    }
  }

  async runFix() {
    console.log('üîß ÿ®ÿØÿ° ÿ™ÿ≠ÿØŸäÿ´ migrations Ÿàÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿØŸÑŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™...\n');
    console.log('üìÖ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:', new Date().toLocaleString('ar-EG'));
    console.log('üéØ ÿßŸÑŸáÿØŸÅ: ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÜÿ¥ÿ± Ÿàÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿ®ÿµÿ±Ÿä');
    console.log('='.repeat(80));
    
    const connected = await this.connect();
    if (!connected) {
      return false;
    }

    try {
      // ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸÜŸäÿ© ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
      const analysis = await this.analyzeCurrentSchema();
      if (!analysis) {
        console.log('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸÜŸäÿ© ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
        return false;
      }

      // ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ migration ŸÖÿ≠ÿØÿ´
      const migrationCreated = await this.createUpdatedInitialMigration();
      if (!migrationCreated) {
        console.log('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ŸÖŸÑŸÅ migration ŸÖÿ≠ÿØÿ´');
        return false;
      }

      // ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿØŸÑŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™
      const displayFixed = await this.fixAccountTreeDisplay();
      if (!displayFixed) {
        console.log('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿØŸÑŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™');
        return false;
      }

      // ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ŸÉÿ±Ÿäÿ®ÿ™ ÿßŸÑŸÜÿ¥ÿ± ÿßŸÑÿ¢ŸÑŸä
      const deploymentCreated = await this.createDeploymentScript();
      if (!deploymentCreated) {
        console.log('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ŸÉÿ±Ÿäÿ®ÿ™ ÿßŸÑŸÜÿ¥ÿ±');
        return false;
      }

      console.log('\nüéâ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ migrations Ÿàÿ•ÿµŸÑÿßÿ≠ ÿπÿ±ÿ∂ ÿØŸÑŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!');
      console.log('‚úÖ ŸÖŸÑŸÅ migration ŸÖÿ≠ÿØÿ´ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ§Ÿá');
      console.log('‚úÖ ÿπÿ±ÿ∂ ÿØŸÑŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠Ÿá');
      console.log('‚úÖ ÿ≥ŸÉÿ±Ÿäÿ®ÿ™ ÿßŸÑŸÜÿ¥ÿ± ÿßŸÑÿ¢ŸÑŸä ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ§Ÿá');
      
      return true;
      
    } catch (error) {
      console.error('‚ùå ÿÆÿ∑ÿ£ ÿπÿßŸÖ ŸÅŸä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´:', error.message);
      return false;
    } finally {
      await this.disconnect();
    }
  }
}

// ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ•ÿµŸÑÿßÿ≠
const fix = new MigrationsAndDisplayFix();
fix.runFix().then(success => {
  if (success) {
    console.log('\nüéä ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸÜÿ¨ÿßÿ≠!');
    console.log('üìã ÿßŸÑÿ¢ŸÜ ŸÖŸÑŸÅÿßÿ™ migrations ŸÖÿ≠ÿØÿ´ÿ© ÿ®ÿ¢ÿÆÿ± ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™');
    console.log('üé® ÿØŸÑŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™ Ÿäÿπÿ±ÿ∂ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠ ŸàŸÖŸÜÿ∏ŸÖ');
    console.log('üöÄ ÿ≥ŸÉÿ±Ÿäÿ®ÿ™ ÿßŸÑŸÜÿ¥ÿ± ÿßŸÑÿ¢ŸÑŸä ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ');
    process.exit(0);
  } else {
    console.log('\n‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´');
    process.exit(1);
  }
}).catch(error => {
  console.error('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´:', error);
  process.exit(1);
});
