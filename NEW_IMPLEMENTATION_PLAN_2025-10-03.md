# خطة التنفيذ الجديدة — 2025-10-03

## الهدف العام
تحويل النظام إلى منصة محاسبية ومبيعات متقدمة مهيأة لعمليات الشحن الدولي (الصين ← ليبيا)، مع:
- محرك محاسبي متكامل (فترات محاسبية، إقفالات، صحة النظام، تدقيق).
- نظام أصول ثابتة متكامل (تصنيفات، إهلاك، قيود تلقائية، تقارير).
- إعادة هيكلة لوحة المبيعات لتواكب مؤشرات الشحن الدولي (ETD/ETA، خطوط الشحن، حالة التخليص، الربحية).
- إزالة سكربتات/مكونات الاختبار المزروعة من واجهات الإنتاج.

---

## نطاق العمل (Workstreams)

### 1) المحرك المحاسبي v2
- الفترات المحاسبية وإقفالات الفترة:
  - استكمال منطق AccountingPeriod.closePeriod وإنشاء قيد إقفال تلقائي (إغلاق الإيرادات والمصروفات إلى الأرباح المحتجزة أو حساب الأرباح).
  - إضافة صلاحيات وسجل تدقيق (closedBy/closedAt/closingEntryId) وتحقق توازن القيود قبل الإقفال.
- صحة النظام (System Health):
  - توحيد مسار GET /api/financial/system-health لإرجاع: حسابات مطلوبة، الفرق بين أرصدة الحسابات وGL، فواتير بلا قيود.
  - POST /api/financial/recalculate-balances لإعادة احتساب الأرصدة من GL.
  - واجهة صغيرة للعرض ضمن FinancialDashboard (بطاقة حالة النظام وإصلاح سريع).
- سياسات الأخطاء:
  - منع تجاهل فشل إنشاء القيد المحاسبي في sales.js/financial.js؛ العملية تفشل برسالة واضحة.
- المخطط المحاسبي والحسابات الفرعية:
  - تأكيد إنشاء حسابات AR/AP الفرعية تلقائياً لكل عميل/مورد (ensureAccount)، وضمان parentId وهيكل المستويات.
- العملات:
  - إضافة خدمة ExchangeRateService (قابلة للاستبدال) مع إمكانية تحويل مبالغ للعرض التقريبي في التقارير متعددة العملات.
- المراقبة والأداء:
  - الاستفادة من Redis caching في تقارير القراءة الثقيلة (اختياري عبر feature flag).

المخرجات/القبول:
- تمرير System Health دون مشاكل حرجة.
- نجاح إقفال فترة بها معاملات فعلية وإنشاء قيد الإقفال.
- فشل آمن لأي عملية محاسبية عند عدم إنشاء القيود.


### 2) الأصول الثابتة v2
- التصنيفات والهيكلة:
  - توحيد تصنيفات الأصول وربطها بحسابات الميزانية (أصل/مجمع إهلاك/مصروف إهلاك).
- الإهلاك:
  - DepreciationService: طريقة الخط المستقيم (Straight-line) مع جدول زمني تلقائي شهري.
  - إنشاء قيود الإهلاك الشهرية تلقائياً (cron شهري مع إمكانية التشغيل اليدوي).
- التقارير:
  - تقرير سجل الأصول، تقرير الإهلاك الشهري/السنوي، صافي القيمة الدفترية.

المخرجات/القبول:
- إنشاء أصل جديد يكوّن حساباته تلقائياً (إن لزم) ويظهر في التقارير.
- عملية إهلاك شهرية تنتج قيوداً متوازنة وتنعكس على القوائم.


### 3) إعادة هيكلة لوحة المبيعات (متطلبات الشحن الدولي)
- مؤشرات رئيسية (KPIs):
  - الشحنات حسب الحالة: pending, in_transit, arrived, customs_clearance, cleared, delivered.
  - الإيراد/الربحية حسب خط الشحن (Shipping Line) والفترة.
  - AR Aging مخصص لشحنات الشحن الدولي.
  - أعلى العملاء من حيث الربحية/الحجم.
- تتبع الشحنات:
  - عرض ETD/ETA، مدة العبور، تأخير الوصول، حالة التخليص.
  - Drill-down من البطاقة إلى قائمة الشحنات ثم تفاصيل الشحنة.
- التقارير:
  - تقرير ربحية الشحنات (by shipment/container/line).
  - مقارنة شهرية (MoM) وسنوية (YoY).

المخرجات/القبول:
- لوحة تعرض KPIs أعلاه بزمن تحميل جيد (<2s مع التخزين المؤقت عند الحاجة).
- تنقل منظم من البطاقات إلى الجداول ثم التفاصيل.


### 4) التنظيف والاختبارات
- إزالة العناصر الاختبارية من الواجهات الإنتاجية:
  - إزالة TestAPI وأي مكونات/نداءات اختبار من صفحات المحاسبة.
- الاختبارات:
  - مجموعة اختبارات تكامل أساسية: إنشاء فاتورة ← قيد محاسبي؛ إقفال فترة؛ تقرير أرصدة.
  - Smoke E2E للنقاط الحرجة (CI قابل للتشغيل محلياً).


### 5) DevOps وحوكمة
- Feature flags (ENV) لتفعيل/تعطيل Redis caching، تثبيت Triggers، تشغيل الإهلاك الشهري.
- CI: تشغيل lint/test/build والتأكد من المهاجرات قبل النشر.

---

## التغييرات التقنية المقترحة

### قاعدة البيانات
- تفعيل ونشر Triggers للأرصدة (gl_entries ← accounts.balance) والتأكد من تشغيلها في جميع البيئات.
- إن لزم، إضافة أعمدة closingEntryId/closedBy/closedAt إلى periods.

### API (عينة)
- GET /api/financial/system-health
- POST /api/financial/recalculate-balances
- POST /api/fixed-assets/depreciation/run (يدوياً) + Cron شهري
- GET /api/sales/shipments/summary?period=...&status=...
- GET /api/sales/revenue-by-line?period=...
- GET /api/sales/ar-aging

### الواجهة (Frontend)
- FinancialDashboard: بطاقة System Health، بطاقات سريعة لإدارة الفترات والإقفالات، تقارير الأرصدة.
- SalesDashboard: أقسام KPIs للشحن الدولي + جداول قابلة للتصفية + روابط للتفاصيل.
- FixedAssets: شاشة إدارة الأصول، جدولة الإهلاك، تقارير.

---

## الجدول الزمني (مقترح 2–3 أسابيع)
- الأسبوع 1:
  - المحرك المحاسبي v2: System Health + Recalculate + سياسة الأخطاء + Triggers.
  - تنظيف الواجهة من مكونات الاختبار.
- الأسبوع 2:
  - الأصول الثابتة v2: DepreciationService + واجهة الإهلاك + تقارير أولية.
- الأسبوع 3:
  - إعادة هيكلة لوحة المبيعات + تقارير الشحنات.
  - تحسين الأداء والتخزين المؤقت.

---

## معايير القبول (Acceptance Criteria)
- النجاح في إقفال فترة مع معاملات حقيقية وإنشاء قيد إقفال متوازن.
- System Health يظهر 0 مشاكل حرجة بعد الإصلاحات.
- لوحة المبيعات تعرض KPIs للشحن الدولي وDrill-down فعال.
- الإهلاك الشهري يُنشئ قيوداً صحيحة وتنعكس على التقارير.
- لا توجد عناصر/مكونات اختبار ظاهرة في الواجهات الإنتاجية.

---

## المخاطر وخطة التراجع
- مخاطر: تعارضات مهاجرات/Triggers، بطء الاستعلامات، اختلاف بيئات.
- التخفيف: تشغيل في بيئة تجريبية، مراقبة زمن الاستجابة، Feature flags للتعطيل السريع.
- التراجع: disable flags، rollback مهاجرات، إعادة نشر النسخة السابقة.
