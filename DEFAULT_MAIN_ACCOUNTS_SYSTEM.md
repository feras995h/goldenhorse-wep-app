# نظام الحسابات الرئيسية الافتراضية

## 📋 نظرة عامة

تم تطوير نظام شامل لضمان وجود الحسابات الرئيسية الافتراضية في النظام المحاسبي عند النشر على أي استضافة. النظام يضمن إنشاء 5 حسابات رئيسية تلقائياً وفقاً للتصنيف المحاسبي التقليدي.

## 🎯 الحسابات الرئيسية الافتراضية

| الكود | اسم الحساب | النوع | الطبيعة | التقرير | الوصف |
|-------|------------|-------|---------|----------|--------|
| 1 | الأصول | asset | مدين | الميزانية العمومية | جميع الأصول المملوكة للشركة |
| 2 | المصروفات | expense | مدين | قائمة الدخل | جميع المصروفات التشغيلية والإدارية |
| 3 | الالتزامات | liability | دائن | الميزانية العمومية | جميع الديون والالتزامات المالية |
| 4 | حقوق الملكية | equity | دائن | الميزانية العمومية | رأس المال والأرباح المحتجزة |
| 5 | الإيرادات | revenue | دائن | قائمة الدخل | جميع الإيرادات من المبيعات والخدمات |

## 🏗️ مكونات النظام

### 1. ملف الحسابات الافتراضية
**المسار**: `server/src/utils/ensureDefaultAccounts.js`

يحتوي على:
- تعريف الحسابات الرئيسية الافتراضية
- دالة `ensureDefaultMainAccounts()` لضمان وجود الحسابات
- دالة `validateMainAccounts()` للتحقق من صحة الحسابات

### 2. Seeder للحسابات الرئيسية
**المسار**: `server/src/seeders/001-default-main-accounts.js`

- Seeder متوافق مع Sequelize CLI
- يمكن تشغيله باستخدام `npm run db:seed`
- يتحقق من الحسابات الموجودة قبل الإنشاء

### 3. سكريپت ضمان الحسابات
**المسار**: `server/src/scripts/ensureMainAccounts.js`

- سكريپت مستقل لضمان وجود الحسابات
- يمكن تشغيله باستخدام `npm run ensure-main-accounts`
- يتضمن التحقق من صحة الحسابات

### 4. تكامل مع بدء النظام
**المسار**: `server/src/utils/databaseInit.js`

- يتم استدعاء دالة ضمان الحسابات تلقائياً عند بدء النظام
- يضمن وجود الحسابات في كل مرة يبدأ فيها الخادم

## 🚀 طرق التشغيل

### 1. تلقائياً عند بدء النظام
```bash
npm start
# أو
npm run dev
```
النظام سيتحقق تلقائياً من وجود الحسابات الرئيسية ويُنشئها إذا لم تكن موجودة.

### 2. يدوياً باستخدام السكريپت المخصص
```bash
npm run ensure-main-accounts
```

### 3. باستخدام Sequelize Seeder
```bash
npm run db:seed
```

### 4. عند النشر
```bash
npm run deploy
```
يتضمن أمر النشر تشغيل ضمان الحسابات الرئيسية.

## 📦 إعدادات النشر

### Nixpacks (Coolify/Railway)
تم تحديث `nixpacks.toml` ليتضمن مرحلة إعداد قاعدة البيانات:

```toml
[phases.setup-db]
cmds = [
    "cd server && npm run ensure-main-accounts"
]
```

### Package.json Scripts
تم إضافة السكريپتات التالية:

```json
{
  "ensure-main-accounts": "node src/scripts/ensureMainAccounts.js",
  "prepare-production": "npm run clean-database && npm run setup-production && npm run ensure-main-accounts",
  "deploy": "node src/scripts/checkDeployment.js && npm run db:migrate && npm run ensure-main-accounts && npm run seed-basic-data"
}
```

## 🔧 الميزات

### 1. الأمان والموثوقية
- ✅ التحقق من وجود الحسابات قبل الإنشاء
- ✅ عدم الكتابة فوق الحسابات الموجودة
- ✅ معالجة الأخطاء الشاملة
- ✅ رسائل واضحة ومفصلة

### 2. المرونة
- ✅ يعمل مع SQLite و PostgreSQL
- ✅ متوافق مع جميع منصات الاستضافة
- ✅ يمكن تشغيله في أي وقت دون مشاكل
- ✅ قابل للتخصيص والتوسيع

### 3. التكامل
- ✅ يعمل تلقائياً عند بدء النظام
- ✅ متكامل مع عملية النشر
- ✅ متوافق مع أدوات CI/CD
- ✅ يدعم البيئات المختلفة (development/production)

## 📊 مثال على الاستخدام

### عند بدء النظام لأول مرة:
```
🔍 التحقق من وجود الحسابات الرئيسية الافتراضية...
📊 الحسابات الرئيسية الموجودة: لا توجد
📝 سيتم إنشاء 5 حساب رئيسي مفقود
  ✓ 1 - الأصول (asset) - طبيعة: debit
  ✓ 2 - المصروفات (expense) - طبيعة: debit
  ✓ 3 - الالتزامات (liability) - طبيعة: credit
  ✓ 4 - حقوق الملكية (equity) - طبيعة: credit
  ✓ 5 - الإيرادات (revenue) - طبيعة: credit
✅ تم إنشاء 5 حساب رئيسي جديد
```

### عند بدء النظام مع وجود الحسابات:
```
🔍 التحقق من وجود الحسابات الرئيسية الافتراضية...
📊 الحسابات الرئيسية الموجودة: 1, 2, 3, 4, 5
✅ جميع الحسابات الرئيسية موجودة بالفعل
```

## 🛠️ الصيانة والتطوير

### إضافة حسابات جديدة
لإضافة حسابات رئيسية جديدة، قم بتحديث:
1. `DEFAULT_MAIN_ACCOUNTS` في `ensureDefaultAccounts.js`
2. `expectedClassification` في دالة `validateMainAccounts()`

### التخصيص
يمكن تخصيص:
- أسماء الحسابات
- أكواد الحسابات
- أوصاف الحسابات
- العملة الافتراضية

### الاختبار
```bash
# اختبار النظام
node server/test-ensure-accounts.js

# التحقق من الحسابات
npm run ensure-main-accounts
```

## 📝 ملاحظات مهمة

1. **الحسابات النظام**: جميع الحسابات الرئيسية مُعلمة كـ `isSystemAccount: true`
2. **عدم الحذف**: الحسابات الرئيسية محمية من الحذف العرضي
3. **التحديث الآمن**: يمكن تحديث خصائص الحسابات دون فقدان البيانات
4. **التوافق**: النظام متوافق مع الإصدارات السابقة

## ✅ الخلاصة

تم إنشاء نظام شامل وموثوق لضمان وجود الحسابات الرئيسية الافتراضية في النظام المحاسبي. النظام:

- ✅ يعمل تلقائياً عند النشر على أي استضافة
- ✅ يضمن وجود 5 حسابات رئيسية بالتصنيف الصحيح
- ✅ آمن وموثوق ولا يؤثر على البيانات الموجودة
- ✅ قابل للصيانة والتطوير
- ✅ متكامل مع جميع أجزاء النظام

---

**تاريخ الإنشاء**: 2025-01-13  
**الحالة**: مكتمل ومُختبر ✅  
**المطور**: Augment Agent
