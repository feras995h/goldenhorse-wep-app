import { Sequelize, DataTypes } from 'sequelize';
import bcrypt from 'bcryptjs';
import dotenv from 'dotenv';

dotenv.config();

const dbUrl = (process.env.DB_URL || process.env.DATABASE_URL || '').trim();
const sequelize = new Sequelize(dbUrl, { 
  dialect: 'postgres', 
  logging: false 
});

/**
 * Ø³ÙƒØ±ÙŠØ¨Øª Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… admin Ø§ÙØªØ±Ø§Ø¶ÙŠ
 */
async function createAdminUser() {
  try {
    console.log('ğŸ” Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    await sequelize.authenticate();
    console.log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­\n');

    console.log('ğŸ‘¤ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… admin...\n');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const [existingUsers] = await sequelize.query(`
      SELECT * FROM users WHERE username = 'admin';
    `);

    if (existingUsers.length > 0) {
      console.log('âš ï¸  Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… admin Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
      console.log('   ID:', existingUsers[0].id);
      console.log('   Username:', existingUsers[0].username);
      console.log('   Role:', existingUsers[0].role);
      console.log('\nâœ… Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯');
      await sequelize.close();
      return;
    }

    // ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    const hashedPassword = await bcrypt.hash('admin123', 10);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await sequelize.query(`
      INSERT INTO users (
        username, 
        email, 
        password, 
        name, 
        role, 
        "isActive",
        "createdAt",
        "updatedAt"
      ) VALUES (
        'admin',
        'admin@goldenhorse.ly',
        '${hashedPassword}',
        'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
        'admin',
        true,
        NOW(),
        NOW()
      );
    `);

    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… admin Ø¨Ù†Ø¬Ø§Ø­!\n');
    console.log('ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:');
    console.log('   Username: admin');
    console.log('   Password: admin123');
    console.log('   Email: admin@goldenhorse.ly');
    console.log('   Role: admin');
    console.log('   Name: Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…');
    console.log('\nğŸ” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

    await sequelize.close();
    
  } catch (error) {
    console.error('\nâŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
    await sequelize.close();
    process.exit(1);
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª
createAdminUser();
